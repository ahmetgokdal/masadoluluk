# Smart Cabin Monitoring System - Backend Contracts

## API Endpoints

### Authentication (Google OAuth)
- `POST /api/auth/session` - Process session_id from Google OAuth and create session
- `GET /api/auth/me` - Get current authenticated user
- `POST /api/auth/logout` - Logout user and clear session

### Dashboard & Stats
- `GET /api/stats` - Get overall system statistics
- `GET /api/cabins` - Get all cabins with current status
- `GET /api/alerts` - Get active alerts (long breaks, camera offline, no data)
- `GET /api/activity/daily` - Get daily activity chart data
- `GET /api/activity/weekly` - Get weekly activity chart data

### Cabins
- `GET /api/cabins/{cabin_no}` - Get specific cabin details
- `GET /api/cabins/{cabin_no}/snapshot` - Proxy camera snapshot
- `POST /api/cabins/{cabin_no}/assign` - Assign student to cabin
- `DELETE /api/cabins/{cabin_no}/unassign` - Remove student from cabin

### Students
- `GET /api/students` - Get all students with their cabin assignments
- `POST /api/students` - Create/assign new student
- `PUT /api/students/{student_id}` - Update student info
- `DELETE /api/students/{student_id}` - Remove student assignment

### Reports
- `GET /api/reports` - List all generated reports
- `POST /api/reports/generate` - Generate new report (daily/weekly/monthly)
- `GET /api/reports/{report_id}/download` - Download specific report
- `POST /api/reports/{report_id}/send` - Send report via Telegram

### Settings
- `GET /api/settings/telegram` - Get Telegram configuration
- `PUT /api/settings/telegram` - Update Telegram configuration
- `GET /api/settings/cameras` - Get camera configurations
- `POST /api/settings/cameras` - Add new camera
- `DELETE /api/settings/cameras/{cabin_no}` - Remove camera

### Real-time Updates (WebSocket)
- `WS /api/ws` - WebSocket connection for real-time cabin status updates

## MongoDB Collections

### users
```json
{
  "_id": "user_uuid",
  "email": "admin@example.com",
  "name": "Admin User",
  "picture": "https://...",
  "created_at": "2025-01-15T10:00:00Z"
}
```

### user_sessions
```json
{
  "_id": "session_uuid",
  "user_id": "user_uuid",
  "session_token": "token_string",
  "expires_at": "2025-01-22T10:00:00Z",
  "created_at": "2025-01-15T10:00:00Z"
}
```

### cabins
```json
{
  "_id": "cabin_uuid",
  "cabin_no": 1,
  "camera_url": "http://192.168.3.210/capture",
  "student_id": "STU001",
  "student_name": "Öğrenci 1",
  "status": "active",
  "current_session_start": "2025-01-15T10:00:00Z",
  "current_session_duration": 3600,
  "last_activity": "2025-01-15T11:00:00Z",
  "created_at": "2025-01-15T10:00:00Z",
  "updated_at": "2025-01-15T11:00:00Z"
}
```

### sessions
```json
{
  "_id": "session_uuid",
  "cabin_no": 1,
  "student_id": "STU001",
  "student_name": "Öğrenci 1",
  "start_time": "2025-01-15T10:00:00Z",
  "end_time": "2025-01-15T11:30:00Z",
  "duration": 5400,
  "detection_method": "mediapipe",
  "created_at": "2025-01-15T11:30:00Z"
}
```

### reports
```json
{
  "_id": "report_uuid",
  "type": "daily",
  "date": "2025-01-15",
  "cabin_no": 1,
  "student_name": "Öğrenci 1",
  "total_hours": 6.5,
  "sessions_count": 3,
  "filename": "report_daily_cabin1_2025-01-15.pdf",
  "file_path": "/app/backend/reports/report_daily_cabin1_2025-01-15.pdf",
  "created_at": "2025-01-15T21:30:00Z"
}
```

### alerts
```json
{
  "_id": "alert_uuid",
  "type": "long_break",
  "cabin_no": 5,
  "student_name": "Öğrenci 5",
  "message": "2 saattir uzun molada",
  "severity": "warning",
  "resolved": false,
  "created_at": "2025-01-15T10:00:00Z"
}
```

### telegram_config
```json
{
  "_id": "telegram_config",
  "bot_token": "123456789:ABC...",
  "weekly_recipients": ["123456789", "987654321"],
  "cabin_recipients": {
    "1": "111111111",
    "2": "222222222"
  },
  "updated_at": "2025-01-15T10:00:00Z"
}
```

## Mock Data Mapping to Real Data

### mock.js -> Database
1. **mockCabins** -> `cabins` collection
   - All 50 cabins will be seeded initially
   - Real-time status updates via WebSocket

2. **mockStats** -> Calculated from `cabins` and `sessions` collections
   - `total_cabins`: Count from cabins
   - `active_cabins`: Count where status='active'
   - `avg_daily_hours`: Avg from sessions

3. **mockReports** -> `reports` collection
   - Generated PDF files stored in /app/backend/reports/
   - Metadata in database

4. **mockActivityData** -> Aggregated from `sessions` collection
   - Daily: Group by hour, count active sessions
   - Weekly: Group by day, sum total hours

5. **mockAlerts** -> `alerts` collection
   - Generated by background watchdog task

## Backend Implementation Plan

### Phase 1: Core Setup
1. ✅ Setup MongoDB models
2. ✅ Implement Google OAuth with Emergent
3. ✅ Create authentication middleware
4. ✅ Setup WebSocket for real-time updates

### Phase 2: CRUD Endpoints
1. ✅ Cabins endpoints (list, get, assign, unassign)
2. ✅ Students endpoints (list, create, update, delete)
3. ✅ Stats and dashboard data
4. ✅ Settings endpoints (Telegram, cameras)

### Phase 3: Advanced Features
1. ✅ Camera snapshot proxy
2. ✅ Report generation (PDF creation)
3. ✅ Telegram integration
4. ✅ Alert system with background tasks
5. ✅ Activity aggregation and charts

### Phase 4: Frontend Integration
1. Replace mock.js imports with API calls
2. Implement WebSocket connection
3. Add loading states and error handling
4. Setup authentication flow with Google OAuth

## Frontend Changes Required

### Remove Mock Data
- Delete or comment out mock.js imports
- Replace with API service layer

### API Service Layer (src/services/api.js)
```javascript
const API_URL = process.env.REACT_APP_BACKEND_URL + '/api';

export const api = {
  auth: {
    processSession: (sessionId) => axios.post('/auth/session', { session_id: sessionId }),
    getCurrentUser: () => axios.get('/auth/me'),
    logout: () => axios.post('/auth/logout')
  },
  cabins: {
    getAll: () => axios.get('/cabins'),
    getOne: (cabinNo) => axios.get(`/cabins/${cabinNo}`),
    assign: (cabinNo, data) => axios.post(`/cabins/${cabinNo}/assign`, data),
    unassign: (cabinNo) => axios.delete(`/cabins/${cabinNo}/unassign`)
  },
  // ... more endpoints
};
```

### WebSocket Connection
```javascript
const ws = new WebSocket(`ws://localhost:8001/api/ws`);
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  // Update cabin status in state
};
```

## Environment Variables

### Backend (.env)
```
MONGO_URL=mongodb://localhost:27017/
DB_NAME=smart_cabin_db
JWT_SECRET=your_jwt_secret_here
```

### Frontend (.env)
```
REACT_APP_BACKEND_URL=http://localhost:8001
```

## Notes
- All timestamps are stored in UTC timezone
- Session durations are in seconds
- Camera URLs should follow format: http://IP:PORT/capture
- PDF reports are generated using reportlab library
- Telegram bot must be created via @BotFather
